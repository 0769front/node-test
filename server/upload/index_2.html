<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
	<title>Document</title>
    <style>
        #choose{
            display: none;
        }
        canvas{
            width: 100%;
            border: 1px solid #000000;
        }
        #upload{
            display: block;
            margin: 10px;
            height: 60px;
            text-align: center;
            line-height: 60px;
            border: 1px solid;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
<input type="file" id="choose">
<a id="upload">上传</a>

<script>
	var filechooser = document.getElementById("choose");
	var canvas = document.createElement("canvas");
	var ctx = canvas.getContext('2d');
    var maxsize = 200*1024;

    document.getElementById("upload").onclick = function(){
        filechooser.click();
    }

	filechooser.onchange = function(){
		if(!this.files.length) return;

		var file = this.files[0];
		
		if(/\/(?:jpeg|png|gif)/i.test(file.type)){
			var reader = new FileReader();

			reader.onload = function(){
				var result = this.result;

                if(result.length > maxsize){
                    var img = new Image();
                    img.src = result;

                    img.onload = function(){
                        var data = compress(this , file.type);

                        console.log('压缩前：' + result.length);
                        console.log('压缩后：' + data.length);
                        console.log('压缩率：' + parseInt(100*(result.length-data.length)/result.length) + "%");

                        result = data;

                        upload(result , file.type);
                    }
                }else {
                    upload(result , file.type);
                }
			};

			reader.readAsDataURL(file);
		}
	}

    function compress(img , type){
        var width = img.width;
        var height = img.height;

        if(type.indexOf("png") > 0){
            width /= 3;
            height /= 3;
        }

        if(width*height > 2000000){
            var bs = ~~((width*height/2000000) + 1);
            width /= bs;
            height /= bs;
        }

        canvas.width = width;
        canvas.height = height;

        ctx.drawImage(img , 0 , 0 , canvas.width , canvas.height);

        return canvas.toDataURL(type , 0.8);
    }

    function upload(basestr , type){
        var text = window.atob(basestr.split(",")[1]);
        var buffer = new ArrayBuffer(text.length);
        var ubuffer = new Uint8Array(buffer);

        for(var i=0;i<text.length;i++){
            ubuffer[i] = text.charCodeAt(i);
        }

        var Builder = window.WebKitBlobBuilder || window.MozBlobBuilder;
        var blob;

        if(Builder){
            var builder = new Builder();
            builder.append(buffer);
            blob = builder.getBlob(type);
        }else {
            blob = new window.Blob([buffer] , {type : type});
        }

        var xhr = new XMLHttpRequest();
        var formdata = new FormData();
        formdata.append('imagefile' , blob);

        xhr.open('post' , '/cupload');
        xhr.send(formdata);

        xhr.onreadystatechange = function(){
            if(xhr.readyState==4 && xhr.status==200){
                alert('上传成功：' + xhr.responseText);
            }
        }

        xhr.upload.addEventListener('progress' , function(e){
            console.log(~~(100*e.loaded/ e.total) + "%");
        }, false)
        xhr.upload.addEventListener('load', function(){
            console.log(~~(100*e.loaded/ e.total) + "%");
        }, false);
    }
</script>
</body>
</html>